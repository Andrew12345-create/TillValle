<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shop - TillValle</title>
  <link rel="stylesheet" href="css/site.css">
  <link rel="stylesheet" href="css/navbar.css">
  <link rel="icon" href="logo.jpg" type="image/jpeg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">

  <link rel="stylesheet" href="global-chat.css">
  <!-- Hotjar Tracking Code -->
  <script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:5208839,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
  </script>
  <style>

  :root {
    --brand-500:#40916c;
    --muted:#64748b;
    --bg:#f6fbf7;
    --card:#ffffff;
    --glass:rgba(255,255,255,0.6);
    --radius:10px;
    --max-w:1100px;
  }
  *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Poppins',Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#e8f6ef);color:#072018}

    /* Page container */
    #navbar-container{width:100%;}
    .shop-section{max-width:var(--max-w);margin:22px auto;padding:18px}
    .shop-section h2{font-size:1.8rem;margin:0 0 12px;color:var(--brand-600);letter-spacing:0.2px}

    /* Categories */
    .category{margin:18px 0}
    .category-title{font-weight:600;color:var(--brand-700);margin-bottom:8px}

    /* Product grid */
  .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
  .product{background:var(--card);border-radius:10px;padding:10px;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;transition:transform .16s ease,box-shadow .16s ease;box-shadow:0 6px 18px rgba(3,8,6,0.06);min-height:180px}
    .product:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(3,8,6,0.08)}

  .product-image{width:100%;height:100px;object-fit:contain;border-radius:8px;background:linear-gradient(180deg,#fff,#f8fffb);padding:6px}
  .product h4{font-size:0.95rem;margin:8px 0 6px;text-align:center;color:#072018}
  .product .price{color:var(--muted);font-weight:700;margin-bottom:6px;font-size:0.95rem}

    /* Recently bought */
    .recent-section{margin:12px 0 20px;padding:8px 6px}
    .recent-title{font-size:1rem;margin:0 0 8px;color:var(--brand-700);font-weight:700}
    .recent-list{display:flex;gap:10px;flex-wrap:nowrap;overflow:auto;padding-bottom:6px}
    .recent-item{min-width:140px;background:var(--card);border-radius:10px;padding:8px;display:flex;flex-direction:column;align-items:center;gap:8px;box-shadow:0 6px 18px rgba(3,8,6,0.04)}
    .recent-image{width:84px;height:64px;object-fit:cover;border-radius:8px;background:#fff}
    .recent-name{font-size:0.9rem;text-align:center;color:#072018;font-weight:700}
    .recent-price{font-size:0.85rem;color:var(--muted)}
    .recent-buy-btn{background:transparent;border:1px solid var(--brand-600);color:var(--brand-600);padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:700}

    .product-controls{display:flex;align-items:center;gap:6px}
    .product-quantity{min-width:28px;text-align:center;font-weight:700}

    .product-btn{background:var(--brand-600);color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:14px;display:inline-flex;align-items:center;justify-content:center;transition:transform .12s ease}
    .product-btn:active{transform:scale(.98)}

    /* Improved product card look when clicked (visual focus) */
    .product:focus-within,.product:focus{outline:3px solid rgba(45,106,79,0.12);box-shadow:0 12px 30px rgba(16,24,40,0.06)}

  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(4,10,6,0.55);z-index:120;backdrop-filter:blur(6px)}
  .modal.show{display:flex}
  .modal-content{background:linear-gradient(180deg,#ffffff,#f7fff7);border-radius:20px;max-width:680px;width:92%;padding:26px 28px;display:flex;flex-direction:column;gap:18px;align-items:center;position:relative;box-shadow:0 40px 80px rgba(3,8,6,0.18)}
  .modal-body{width:100%;display:flex;flex-direction:column;align-items:center;gap:12px}
  .modal-image{width:180px;height:140px;object-fit:cover;border-radius:12px;background:#fff;padding:10px;box-shadow:0 8px 20px rgba(3,8,6,0.06)}
  .modal-info{flex:1;text-align:center;padding:6px}
  .modal-info h3{margin:0 0 6px;font-size:1.6rem;color:var(--brand-600);font-weight:800}
  .modal-info p{color:var(--muted);margin:0 0 6px;font-size:1rem;line-height:1.5}
  .modal-price{font-weight:800;color:var(--brand-600);margin-top:6px;font-size:1.05rem}
  .quantity-controls{display:flex;align-items:center;gap:14px;margin-top:8px}
  .quantity-btn{background:var(--brand-600);border:none;padding:12px 14px;border-radius:999px;cursor:pointer;color:#fff;font-weight:800;font-size:18px;box-shadow:0 8px 18px rgba(45,106,79,0.12)}
  .quantity-display{min-width:28px;text-align:center;font-weight:700;font-size:1.05rem}
  .add-to-cart-btn,.buy-now-btn{background:var(--brand-600);color:white;border:none;padding:12px 22px;border-radius:999px;cursor:pointer;margin-right:8px;font-weight:800;font-size:16px;box-shadow:0 12px 30px rgba(45,106,79,0.14)}

  /* Close button */
  .modal .close{position:absolute;top:14px;right:14px;background:#fff;border:none;color:var(--brand-700);font-size:20px;cursor:pointer;padding:8px;border-radius:999px;box-shadow:0 6px 18px rgba(3,8,6,0.08)}
  .modal .close:hover{transform:scale(1.03)}

  /* Affirmative action small icon button (check) */
  .confirm-icon{display:inline-flex;align-items:center;justify-content:center;width:54px;height:44px;border-radius:28px;background:linear-gradient(180deg,var(--brand-600),#1e8c57);color:white;border:none;box-shadow:0 10px 30px rgba(45,106,79,0.18);font-size:18px}

    /* Toast */
    .toast{position:fixed;right:24px;bottom:30px;background:linear-gradient(90deg,var(--brand-600),#56c39f);color:white;padding:12px 18px;border-radius:999px;box-shadow:0 8px 30px rgba(3,8,6,0.12);z-index:9999;font-weight:700}

    /* Floating chatbot */
    .floating-chatbot-btn{position:fixed;right:22px;bottom:22px;background:var(--brand-600);color:#fff;border-radius:999px;padding:12px 14px;font-size:20px;border:none;box-shadow:0 10px 30px rgba(3,8,6,0.12);cursor:pointer}

    /* Loading screen */
    #loading-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#e6f0ff,#e6fff3);z-index:9999}
    .loading-logo{width:74px;height:74px;border-radius:50%;background:url('logo.jpg') center/cover}

    /* Utility */
    .hidden{display:none}

    @media (max-width:900px){.modal-content{flex-direction:column;align-items:center}.modal-image{width:80%;height:180px}}
    @media (max-width:480px){.products{grid-template-columns:repeat(2,1fr)}.product-image{height:100px}.product{min-height:200px}}
  </style>
</head>
<body>
  <div id="navbar-container"></div>

  <section class="shop-section">
    <h2>Fresh Farm Produce</h2>
    <!-- Recently bought (persisted in localStorage) -->
    <div class="recent-section">
      <h3 class="recent-title">Recently Bought</h3>
      <div class="recent-list" id="recent-list" aria-live="polite"></div>
    </div>
    
    <!-- Category: Animal & Farm Produce -->
    <div class="category">
      <h3 class="category-title">Animal & Farm Produce</h3>
      <div class="products animal-farm">
  <div class="product" data-name="Fresh Milk" data-description="Pure, fresh milk from our farm." data-image="milk.png" data-price="120"><img src="milk.png" alt="Fresh Milk" class="product-image"><h4>Fresh Milk</h4><p class="price" data-price="120">KES 120 / liter</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Fresh Milk">−</button><span class="product-quantity" id="qty-Fresh-Milk">0</span><button class="product-btn" data-action="add" data-name="Fresh Milk" data-price="120" data-image="milk.png">+</button></div></div>
  <div class="product" data-name="Free-Range Chicken" data-description="Healthy, free-range chicken." data-image="chicken.png" data-price="800"><img src="chicken.png" alt="Free-Range Chicken" class="product-image"><h4>Free-Range Chicken</h4><p class="price" data-price="800">KES 800 / kg</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Free-Range Chicken">−</button><span class="product-quantity" id="qty-Free-Range-Chicken">0</span><button class="product-btn" data-action="add" data-name="Free-Range Chicken" data-price="800" data-image="chicken.png">+</button></div></div>
  <div class="product" data-name="Farm Fresh Eggs" data-description="Fresh eggs from free-range chickens." data-image="eggs.png" data-price="25"><img src="eggs.png" alt="Farm Fresh Eggs" class="product-image"><h4>Farm Fresh Eggs</h4><p class="price" data-price="25">KES 25 / piece</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Farm Fresh Eggs">−</button><span class="product-quantity" id="qty-Farm-Fresh-Eggs">0</span><button class="product-btn" data-action="add" data-name="Farm Fresh Eggs" data-price="25" data-image="eggs.png">+</button></div></div>
  <div class="product" data-name="Pure Ghee" data-description="Traditional clarified butter." data-image="ghee.png" data-price="600"><img src="ghee.png" alt="Pure Ghee" class="product-image"><h4>Pure Ghee</h4><p class="price" data-price="600">KES 600 / 500g</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Pure Ghee">−</button><span class="product-quantity" id="qty-Pure-Ghee">0</span><button class="product-btn" data-action="add" data-name="Pure Ghee" data-price="600" data-image="ghee.png">+</button></div></div>
  <div class="product" data-name="Honey" data-description="Pure, natural honey from local beekeepers." data-image="honey.png" data-price="400"><img src="honey.png" alt="Honey" class="product-image"><h4>Honey</h4><p class="price" data-price="400">KES 400 / 500g</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Honey">−</button><span class="product-quantity" id="qty-Honey">0</span><button class="product-btn" data-action="add" data-name="Honey" data-price="400" data-image="honey.png">+</button></div></div>
      </div>
    </div>

    <!-- Category: Fruits -->
    <div class="category">
      <h3 class="category-title">Fruits</h3>
      <div class="products">
  <div class="product" data-name="Bananas" data-description="Fresh bananas, perfect for snacking." data-image="bananas-ripe.png" data-price="150"><img src="bananas-ripe.png" alt="Bananas" class="product-image"><h4>Bananas</h4><p class="price" data-price="150">KES 150 / bunch</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Bananas">−</button><span class="product-quantity" id="qty-Bananas">0</span><button class="product-btn" data-action="add" data-name="Bananas" data-price="150" data-image="bananas-ripe.png">+</button></div></div>
  <div class="product" data-name="Oranges" data-description="Juicy oranges, rich in vitamin C." data-image="oranges.png" data-price="200"><img src="oranges.png" alt="Oranges" class="product-image"><h4>Oranges</h4><p class="price" data-price="200">KES 200 / kg</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Oranges">−</button><span class="product-quantity" id="qty-Oranges">0</span><button class="product-btn" data-action="add" data-name="Oranges" data-price="200" data-image="oranges.png">+</button></div></div>

  <div class="product" data-name="Watermelon" data-description="Sweet watermelon, perfect for hot days." data-image="watermelon.png" data-price="250"><img src="watermelon.png" alt="Watermelon" class="product-image"><h4>Watermelon</h4><p class="price" data-price="250">KES 250 / piece</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Watermelon">−</button><span class="product-quantity" id="qty-Watermelon">0</span><button class="product-btn" data-action="add" data-name="Watermelon" data-price="250" data-image="watermelon.png">+</button></div></div>
  <div class="product" data-name="Mangoes" data-description="Juicy mangoes, perfect for summer." data-image="mangoes.png" data-price="40"><img src="mangoes.png" alt="Mangoes" class="product-image"><h4>Mangoes</h4><p class="price" data-price="40">KES 40 / piece</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Mangoes">−</button><span class="product-quantity" id="qty-Mangoes">0</span><button class="product-btn" data-action="add" data-name="Mangoes" data-price="40" data-image="mangoes.png">+</button></div></div>
  <div class="product" data-name="Lemon" data-description="Fresh lemons for cooking and drinks." data-image="lemon.png" data-price="20"><img src="lemon.png" alt="Lemon" class="product-image"><h4>Lemon</h4><p class="price" data-price="20">KES 20 / piece</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Lemon">−</button><span class="product-quantity" id="qty-Lemon">0</span><button class="product-btn" data-action="add" data-name="Lemon" data-price="20" data-image="lemon.png">+</button></div></div>
  <div class="product" data-name="Pawpaw" data-description="Sweet pawpaw fruit, rich in vitamins." data-image="pawpaw.png" data-price="120"><img src="pawpaw.png" alt="Pawpaw" class="product-image"><h4>Pawpaw</h4><p class="price" data-price="120">KES 120 / piece</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Pawpaw">−</button><span class="product-quantity" id="qty-Pawpaw">0</span><button class="product-btn" data-action="add" data-name="Pawpaw" data-price="120" data-image="pawpaw.png">+</button></div></div>
  <div class="product" data-name="Pixies" data-description="Mini sweet oranges, great for snacking." data-image="pixies.png" data-price="35"><img src="pixies.png" alt="Pixies" class="product-image"><h4>Pixies</h4><p class="price" data-price="35">KES 35 / piece</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Pixies">−</button><span class="product-quantity" id="qty-Pixies">0</span><button class="product-btn" data-action="add" data-name="Pixies" data-price="35" data-image="pixies.png">+</button></div></div>
  <div class="product" data-name="Avocadoes" data-description="Creamy avocados for healthy eating." data-image="avocadoes.png" data-price="30"><img src="avocadoes.png" alt="Avocadoes" class="product-image"><h4>Avocadoes</h4><p class="price" data-price="30">KES 30 / piece</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Avocadoes">−</button><span class="product-quantity" id="qty-Avocadoes">0</span><button class="product-btn" data-action="add" data-name="Avocadoes" data-price="30" data-image="avocadoes.png">+</button></div></div>
  <div class="product" data-name="Yellow Passion" data-description="Tangy passion fruit for juices." data-image="yellow-passion.png" data-price="25"><img src="yellow-passion.png" alt="Yellow Passion" class="product-image"><h4>Yellow Passion</h4><p class="price" data-price="25">KES 25 / piece</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Yellow Passion">−</button><span class="product-quantity" id="qty-Yellow-Passion">0</span><button class="product-btn" data-action="add" data-name="Yellow Passion" data-price="25" data-image="yellow-passion.png">+</button></div></div>
  <div class="product" data-name="Kiwi" data-description="Nutritious kiwi fruit, full of vitamin C." data-image="kiwi.png" data-price="60"><img src="kiwi.png" alt="Kiwi" class="product-image"><h4>Kiwi</h4><p class="price" data-price="60">KES 60 / piece</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Kiwi">−</button><span class="product-quantity" id="qty-Kiwi">0</span><button class="product-btn" data-action="add" data-name="Kiwi" data-price="60" data-image="kiwi.png">+</button></div></div>
  <div class="product" data-name="Raw Bananas" data-description="Green bananas for cooking." data-image="raw-bananas.png" data-price="100"><img src="raw-bananas.png" alt="Raw Bananas" class="product-image"><h4>Raw Bananas</h4><p class="price" data-price="100">KES 100 / bunch</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Raw Bananas">−</button><span class="product-quantity" id="qty-Raw-Bananas">0</span><button class="product-btn" data-action="add" data-name="Raw Bananas" data-price="100" data-image="raw-bananas.png">+</button></div></div>
  <div class="product" data-name="Dragon Fruit" data-description="Exotic dragon fruit, sweet and nutritious." data-image="dragonfruit.png" data-price="300"><img src="dragonfruit.png" alt="Dragon Fruit" class="product-image"><h4>Dragon Fruit</h4><p class="price" data-price="300">KES 300 / piece</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Dragon Fruit">−</button><span class="product-quantity" id="qty-Dragon-Fruit">0</span><button class="product-btn" data-action="add" data-name="Dragon Fruit" data-price="300" data-image="dragonfruit.png">+</button></div></div>
  <div class="product" data-name="Soursop" data-description="Tropical soursop fruit, great for juices." data-image="soursop.png" data-price="250"><img src="soursop.png" alt="Soursop" class="product-image"><h4>Soursop</h4><p class="price" data-price="250">KES 250 / piece</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Soursop">−</button><span class="product-quantity" id="qty-Soursop">0</span><button class="product-btn" data-action="add" data-name="Soursop" data-price="250" data-image="soursop.png">+</button></div></div>
      </div>
    </div>

    <!-- Category: Herbs -->
    <div class="category">
      <h3 class="category-title">Herbs</h3>
      <div class="products">
  <div class="product" data-name="Basil" data-description="Fresh basil leaves for cooking." data-image="basil.png" data-price="50"><img src="basil.png" alt="Basil" class="product-image"><h4>Basil</h4><p class="price" data-price="50">KES 50 / bunch</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Basil">−</button><span class="product-quantity" id="qty-Basil">0</span><button class="product-btn" data-action="add" data-name="Basil" data-price="50" data-image="basil.png">+</button></div></div>
  <div class="product" data-name="Coriander" data-description="Aromatic coriander leaves and seeds." data-image="coriander.png" data-price="30"><img src="coriander.png" alt="Coriander" class="product-image"><h4>Coriander</h4><p class="price" data-price="30">KES 30 / bunch</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Coriander">−</button><span class="product-quantity" id="qty-Coriander">0</span><button class="product-btn" data-action="add" data-name="Coriander" data-price="30" data-image="coriander.png">+</button></div></div>
  <div class="product" data-name="Mint" data-description="Fresh mint leaves for cooking and drinks." data-image="mint.png" data-price="40"><img src="mint.png" alt="Mint" class="product-image"><h4>Mint</h4><p class="price" data-price="40">KES 40 / bunch</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Mint">−</button><span class="product-quantity" id="qty-Mint">0</span><button class="product-btn" data-action="add" data-name="Mint" data-price="40" data-image="mint.png">+</button></div></div>
  <div class="product" data-name="Parsley" data-description="Fresh parsley leaves for cooking." data-image="parsley.png" data-price="35"><img src="parsley.png" alt="Parsley" class="product-image"><h4>Parsley</h4><p class="price" data-price="35">KES 35 / bunch</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Parsley">−</button><span class="product-quantity" id="qty-Parsley">0</span><button class="product-btn" data-action="add" data-name="Parsley" data-price="35" data-image="parsley.png">+</button></div></div>
  <div class="product" data-name="Soursop Leaves" data-description="Medicinal soursop leaves." data-image="soursop-herbs.png" data-price="200"><img src="soursop-herbs.png" alt="Soursop Leaves" class="product-image"><h4>Soursop Leaves</h4><p class="price" data-price="200">from KES 200</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Soursop Leaves">−</button><span class="product-quantity" id="qty-Soursop-Leaves">0</span><button class="product-btn" data-action="add" data-name="Soursop Leaves" data-price="200" data-image="soursop-herbs.png">+</button></div></div>
      </div>
    </div>

    <!-- Category: Vegetables & Greens -->
    <div class="category">
      <h3 class="category-title">Vegetables & Greens</h3>
      <div class="products">
  <div class="product" data-name="Kales (Sukuma Wiki)" data-description="Nutritious kales, perfect for sukuma wiki." data-image="kales.png" data-price="30"><img src="kales.png" alt="Kales (Sukuma Wiki)" class="product-image"><h4>Kales (Sukuma Wiki)</h4><p class="price" data-price="30">KES 30 / bunch</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Kales (Sukuma Wiki)">−</button><span class="product-quantity" id="qty-Kales-(Sukuma-Wiki)">0</span><button class="product-btn" data-action="add" data-name="Kales (Sukuma Wiki)" data-price="30" data-image="kales.png">+</button></div></div>
  <div class="product" data-name="Lettuce" data-description="Fresh, crisp lettuce for salads." data-image="lettuce.png" data-price="80"><img src="lettuce.png" alt="Lettuce" class="product-image"><h4>Lettuce</h4><p class="price" data-price="80">KES 80 / head</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Lettuce">−</button><span class="product-quantity" id="qty-Lettuce">0</span><button class="product-btn" data-action="add" data-name="Lettuce" data-price="80" data-image="lettuce.png">+</button></div></div>
  <div class="product" data-name="Managu" data-description="Traditional African vegetable." data-image="managu.png" data-price="40"><img src="managu.png" alt="Managu" class="product-image"><h4>Managu</h4><p class="price" data-price="40">KES 40 / bunch</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Managu">−</button><span class="product-quantity" id="qty-Managu">0</span><button class="product-btn" data-action="add" data-name="Managu" data-price="40" data-image="managu.png">+</button></div></div>
  <div class="product" data-name="Terere" data-description="Fresh terere leaves for cooking." data-image="terere.png" data-price="40"><img src="terere.png" alt="Terere" class="product-image"><h4>Terere</h4><p class="price" data-price="40">KES 40 / bunch</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Terere">−</button><span class="product-quantity" id="qty-Terere">0</span><button class="product-btn" data-action="add" data-name="Terere" data-price="40" data-image="terere.png">+</button></div></div>
  <div class="product" data-name="Salgaa" data-description="Fresh salgaa for traditional dishes." data-image="salgaa.png" data-price="20"><img src="salgaa.png" alt="Salgaa" class="product-image"><h4>Salgaa</h4><p class="price" data-price="20">KES 20 / bunch</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Salgaa">−</button><span class="product-quantity" id="qty-Salgaa">0</span><button class="product-btn" data-action="add" data-name="Salgaa" data-price="20" data-image="salgaa.png">+</button></div></div>
  <div class="product" data-name="Spinach" data-description="Fresh spinach leaves, rich in iron." data-image="spinach.png" data-price="30"><img src="spinach.png" alt="Spinach" class="product-image"><h4>Spinach</h4><p class="price" data-price="30">KES 30 / bunch</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Spinach">−</button><span class="product-quantity" id="qty-Spinach">0</span><button class="product-btn" data-action="add" data-name="Spinach" data-price="30" data-image="spinach.png">+</button></div></div>
  <div class="product" data-name="Cauliflower" data-description="Fresh cauliflower, perfect for healthy meals." data-image="cauliflower.png" data-price="80"><img src="cauliflower.png" alt="Cauliflower" class="product-image"><h4>Cauliflower</h4><p class="price" data-price="80">KES 80 / head</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Cauliflower">−</button><span class="product-quantity" id="qty-Cauliflower">0</span><button class="product-btn" data-action="add" data-name="Cauliflower" data-price="80" data-image="cauliflower.png">+</button></div></div>
  <div class="product" data-name="Broccoli" data-description="Nutritious broccoli, rich in vitamins." data-image="broccoli.png" data-price="70"><img src="broccoli.png" alt="Broccoli" class="product-image"><h4>Broccoli</h4><p class="price" data-price="70">KES 70 / head</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Broccoli">−</button><span class="product-quantity" id="qty-Broccoli">0</span><button class="product-btn" data-action="add" data-name="Broccoli" data-price="70" data-image="broccoli.png">+</button></div></div>
  <div class="product" data-name="Kunde" data-description="Fresh kunde leaves for traditional dishes." data-image="kunde.png" data-price="40"><img src="kunde.png" alt="Kunde" class="product-image"><h4>Kunde</h4><p class="price" data-price="40">KES 40 / bunch</p><div class="product-controls"><button class="product-btn" data-action="remove" data-name="Kunde">−</button><span class="product-quantity" id="qty-Kunde">0</span><button class="product-btn" data-action="add" data-name="Kunde" data-price="40" data-image="kunde.png">+</button></div></div>
      </div>
    </div>
  </section>

  <!-- Product Modal -->
  <div id="product-modal" class="modal">
    <div class="modal-content">
      <button class="close">&times;</button>
      <div class="modal-body">
        <img id="modal-image" src="" alt="" class="modal-image">
        <div class="modal-info">
          <h3 id="modal-title"></h3>
          <p id="modal-description"></p>
          <div id="modal-price" class="modal-price"></div>
          <div class="quantity-selector">
            <label for="quantity">Select Quantity</label>
            <div class="quantity-controls">
                <button type="button" class="quantity-btn" data-action="decrease">−</button>
                <input type="number" id="quantity" min="1" value="1" readonly>
                <button type="button" class="quantity-btn" data-action="increase">+</button>
              </div>
          </div>
          <div class="modal-buttons">
            <button id="add-to-cart-btn" class="add-to-cart-btn">🛒 Add to Cart</button>
            <button id="buy-now-btn" class="buy-now-btn">⚡ Buy Now</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 TillValle. All rights reserved.</p>
  </footer>

  <!-- Floating Chatbot Button -->
  <button class="floating-chatbot-btn" id="floating-chatbot-btn" title="Chat with TillieBot">
    💬
  </button>

  <!-- Chatbot Sidebar -->
  <div class="chatbot-sidebar" id="chatbot-sidebar">
    <div class="chatbot-header">
      <span>🤖 TillieBot</span>
      <button class="chatbot-close" id="chatbot-close">&times;</button>
    </div>
    <div class="chatbot-messages" id="chatbot-messages">
      <div class="chatbot-message bot">
        🌱 Hello! Welcome to TillValle! I'm TillieBot, your smart farming assistant. How can I help you today?
      </div>
    </div>
    <div class="chatbot-input-area">
      <div class="chatbot-input-container">
        <input type="text" id="chatbot-input" placeholder="Ask me about products, delivery, or stock..." class="chatbot-input">
        <button id="chatbot-send" class="chatbot-send">📤</button>
      </div>
    </div>
  </div>

  <!-- Chatbot Backdrop -->
  <div class="chatbot-backdrop" id="chatbot-backdrop"></div>



  <script>
    // Load navbar
    fetch('navbar.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('navbar-container').innerHTML = data;
      });
    
    // Chatbot functionality - defensive bindings
    const chatBtn = document.getElementById('chat-btn');
    const chatWindow = document.getElementById('chat-window');
    const chatClose = document.getElementById('chat-close');
    if (chatBtn && chatWindow) {
      chatBtn.addEventListener('click', function(){
        chatWindow.style.display = 'flex';
        chatBtn.style.display = 'none';
      });
    }
    if (chatClose && chatWindow && chatBtn) {
      chatClose.addEventListener('click', function(){
        chatWindow.style.display = 'none';
        chatBtn.style.display = 'flex';
      });
    }
    
    function sendMessage() {
      const input = document.getElementById('chat-input');
      const messages = document.getElementById('chat-messages');
      const message = input.value.trim().toLowerCase();
      
      if (!message) return;
      
  // Append user message safely using textContent to avoid HTML injection
  const userMsgDiv = document.createElement('div');
  userMsgDiv.className = 'user-msg';
  userMsgDiv.textContent = input.value;
  messages.appendChild(userMsgDiv);
  input.value = '';
      
  // Show typing indicator
  const typing = document.createElement('div');
  typing.className = 'typing-indicator show';
  typing.textContent = '🤖 TillieBot is typing...';
      messages.appendChild(typing);
      messages.scrollTop = messages.scrollHeight;
      
      setTimeout(() => {
        typing.remove();
        let response = getSmartResponse(message);
  // Append bot response. Responses originate from site logic, so innerHTML is intentional
  const botMsgDiv = document.createElement('div');
  botMsgDiv.className = 'bot-msg';
  botMsgDiv.innerHTML = response;
  messages.appendChild(botMsgDiv);
  messages.scrollTop = messages.scrollHeight;
      }, 1500);
    }
    
    function getSmartResponse(message) {
      if (message.includes('milk') || message.includes('dairy')) {
        return '🥛 <strong>Fresh Milk</strong> - KES 120/liter<br>Our milk comes from free-range cows in Gilgil. Rich in calcium and delivered fresh daily! Would you like to add some to your cart?';
      }
      if (message.includes('egg') || message.includes('chicken')) {
        return '🥚 <strong>Farm Fresh Eggs</strong> - KES 25/piece<br>🐔 <strong>Free-Range Chicken</strong> - KES 800/kg<br>Both from happy, healthy chickens! Perfect for protein-rich meals.';
      }
      if (message.includes('fruit') || message.includes('mango') || message.includes('banana')) {
        return '🍌 <strong>Fresh Fruits Available:</strong><br>• Bananas - KES 150/bunch<br>• Mangoes - KES 40/piece<br>• Avocados - KES 30/piece<br>All picked fresh from our partner farms!';
      }
      if (message.includes('vegetable') || message.includes('kale') || message.includes('spinach')) {
        return '🥬 <strong>Fresh Vegetables:</strong><br>• Kales (Sukuma Wiki) - KES 30/bunch<br>• Spinach - KES 30/bunch<br>• Lettuce - KES 80/head<br>Packed with nutrients and harvested daily!';
      }
      if (message.includes('deliver') || message.includes('shipping')) {
        return '🚚 <strong>Delivery Info:</strong><br>• Nairobi: KES 200 (Same day)<br>• Kiambu: KES 150<br>• Free delivery on orders over KES 2000!';
      }
      if (message.includes('price') || message.includes('cost')) {
        return '💰 <strong>Our Pricing:</strong><br>We offer competitive farm-to-table prices! Check our current rates above. Bulk discounts available!';
      }
      if (message.includes('order') || message.includes('cart')) {
        return '🛒 <strong>Order Help:</strong><br>Click any product above to view details and add to cart. Need help with checkout?';
      }
      if (message.includes('contact') || message.includes('support')) {
        return '📞 <strong>Contact:</strong> support@tillvalle.com<br>📱 <strong>WhatsApp:</strong> +254 700 123 456';
      }
      return '🤔 I can help with product info, pricing, delivery, and orders. What would you like to know?';
    }
    
    const chatSendBtn = document.getElementById('chat-send');
    const chatInput = document.getElementById('chat-input');
    if (chatSendBtn) chatSendBtn.addEventListener('click', sendMessage);
    if (chatInput) chatInput.addEventListener('keypress', function(e){ if (e.key === 'Enter') sendMessage(); });
    
    // Product modal functionality
    let modalCurrentProduct = {};

    function openProductModal(name, description, image, price) {
      modalCurrentProduct = { name, description, image, price };
      
      document.getElementById('modal-title').textContent = name;
      document.getElementById('modal-description').textContent = description;
      document.getElementById('modal-price').textContent = 'KES ' + price;
      document.getElementById('modal-image').src = image;
      document.getElementById('modal-image').alt = name;
      document.getElementById('quantity').value = 1;
      
      const modal = document.getElementById('product-modal');
      modal.style.display = 'flex';
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    
    function closeModal() {
      const modal = document.getElementById('product-modal');
      modal.style.display = 'none';
      modal.classList.remove('show');
      document.body.style.overflow = 'auto';
    }
    
    window.closeModal = closeModal;
    
  // Close modal (defensive)
  const closeBtn = document.querySelector('.close');
  if (closeBtn) closeBtn.addEventListener('click', closeModal);
    
    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('product-modal');
      if (event.target === modal) {
        closeModal();
      }
    };
    
    // Quantity controls (unobtrusive). Attach listeners instead of inline onclicks.
    (function() {
      const modal = document.getElementById('product-modal');

      // Modal-level quantity buttons (increase/decrease)
      if (modal) {
        modal.addEventListener('click', function(e) {
          const btn = e.target.closest('.quantity-btn');
          if (!btn) return;
          const action = btn.dataset.action;
          const input = document.getElementById('quantity');
          if (!input) return;
          let v = parseInt(input.value, 10) || 1;
          if (action === 'increase') v++;
          else if (action === 'decrease' && v > 1) v--;
          input.value = v;
        });
      }

      // Delegated product grid handlers: + / - buttons and product click to open modal
      document.addEventListener('click', function(e) {
        const control = e.target.closest('.product-btn');
        if (control) {
          const action = control.dataset.action;
          const product = control.closest('.product');
          if (!product) return;
          const qtySpan = product.querySelector('.product-quantity');
          let cur = parseInt(qtySpan.textContent, 10) || 0;
          if (action === 'add') cur++;
          else if (action === 'remove' && cur > 0) cur--;
          qtySpan.textContent = cur;
          return; // handled
        }

        // open product modal when clicking a product (but ignore clicks inside controls)
        const productCard = e.target.closest('.product');
        if (productCard && !e.target.closest('.product-controls')) {
          const name = productCard.dataset.name || '';
          const desc = productCard.dataset.description || '';
          const img = productCard.dataset.image || productCard.querySelector('.product-image')?.src || '';
          const price = productCard.dataset.price || productCard.querySelector('.price')?.dataset.price || '';
          openProductModal(name, desc, img, price);
        }
      });
    })();
    
    // Add to cart functionality
    const addToCartBtn = document.getElementById('add-to-cart-btn');
    if (addToCartBtn) addToCartBtn.addEventListener('click', function() {
      const quantity = parseInt(document.getElementById('quantity').value);
      if (quantity > 0) {
        // Persist as a recent purchase
        try {
          saveRecentPurchase(modalCurrentProduct, quantity);
          renderRecentPurchases();
        } catch (e) {
          // ignore storage errors (e.g., private mode)
          console.warn('Could not save recent purchase', e);
        }

        // Add animation to button
        const btn = this;
        btn.style.transform = 'scale(0.95)';
        btn.textContent = '✓ Added!';
        
        setTimeout(() => {
          btn.style.transform = 'scale(1)';
          btn.textContent = '🛒 Add to Cart';
          closeModal();
        }, 1000);
        
        // Show toast notification
        showToast(`Added ${quantity}x ${modalCurrentProduct.name} to cart!`);
      }
    });

    // Recent purchases: storage & rendering
    function getRecentPurchases() {
      try {
        const raw = localStorage.getItem('tillvalle_recent_purchases');
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        return [];
      }
    }

    function saveRecentPurchase(product, quantity) {
      if (!product || !product.name) return;
      const list = getRecentPurchases();
      const entry = {
        name: product.name,
        image: product.image || '',
        price: product.price || product.price === 0 ? product.price : (product.price || ''),
        qty: quantity || 1,
        ts: Date.now()
      };

      // Remove any previous entry with same name
      const filtered = list.filter(it => it.name !== entry.name);
      filtered.unshift(entry); // most recent first
      const limited = filtered.slice(0, 8);
      try { localStorage.setItem('tillvalle_recent_purchases', JSON.stringify(limited)); } catch (e) { /* ignore */ }
    }

    function renderRecentPurchases() {
      const container = document.getElementById('recent-list');
      if (!container) return;
      const list = getRecentPurchases();
      container.innerHTML = '';
      if (!list.length) {
        container.innerHTML = '<div class="recent-empty">No recent purchases yet — buy something and it will appear here.</div>';
        return;
      }
      list.forEach(item => {
        const node = document.createElement('div');
        node.className = 'recent-item';
        node.innerHTML = `
          <img src="${item.image}" alt="${item.name}" class="recent-image">
          <div class="recent-name">${item.name}</div>
          <div class="recent-price">KES ${item.price} × ${item.qty}</div>
          <button class="recent-buy-btn" data-name="${escapeHtmlAttr(item.name)}" data-image="${escapeHtmlAttr(item.image)}" data-price="${escapeHtmlAttr(item.price)}">Buy again</button>
        `;
        container.appendChild(node);
      });
    }

    // Utility escape for attribute insertion
    function escapeHtmlAttr(s) {
      if (s === undefined || s === null) return '';
      return String(s).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    // Handle buy-again clicks (delegated)
    document.addEventListener('click', function(e) {
      const btn = e.target.closest('.recent-buy-btn');
      if (!btn) return;
      const name = btn.dataset.name || '';
      const image = btn.dataset.image || '';
      const price = btn.dataset.price || '';
      openProductModal(name, '', image, price);
      // default to 1 quantity in modal
      const qtyInput = document.getElementById('quantity'); if (qtyInput) qtyInput.value = 1;
    });

    // render on load
    renderRecentPurchases();
    
  // Toast notification
    function showToast(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: linear-gradient(135deg, #00b894, #00cec9);
        color: white;
        padding: 15px 25px;
        border-radius: 50px;
        box-shadow: 0 8px 25px rgba(0,184,148,0.3);
        z-index: 999999;
        font-weight: 600;
        transform: translateY(100px);
        transition: all 0.3s ease;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.style.transform = 'translateY(0)', 100);
      setTimeout(() => {
        toast.style.transform = 'translateY(100px)';
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }
  </script>

  <script src="maintenance.js"></script>
  <script src="navbar-universal.js"></script>
  <script src="script.js" defer></script>
  <script src="global-chat.js"></script>
</body>
</html>
