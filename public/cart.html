<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Cart</title>
  <link rel="stylesheet" href="css/navbar.css">
  <link rel="stylesheet" href="css/site.css" />

  <!-- Hotjar Tracking Code for Tillvalle -->
  <script>
      (function(h,o,t,j,a,r){
          h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
          h._hjSettings={hjid:6534945,hjsv:6};
          a=o.getElementsByTagName('head')[0];
          r=o.createElement('script');r.async=1;
          r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
          a.appendChild(r);
      })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
  </script>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen">
    <img src="logo.jpg" alt="TilleValle" class="loading-logo">
    <div class="loading-spinner"></div>
  </div>
  <link rel="stylesheet" href="css/site.css" />
  <div id="navbar-container"></div>

  <section class="cart-section animated fadeIn" id="cart-section">
    <h2>Your Shopping Cart</h2>
    <div class="cart-container">

      <ul id="cart-items">
        <!-- Cart items will appear here -->
      </ul>
      <b><p id="cart-total">Total: KSh 0</p></b>
      <button id="checkout-btn">Checkout</button>
    </div>
  </section>

  <!-- Payment Section (hidden by default) -->
  <section id="payment-section" style="display:none;" class="animated fadeIn">
    <h2>Payment Details</h2>
    <div class="payment-methods">
      <h3>Select Payment Method</h3>
      <label class="payment-option">
        <input type="radio" name="payment-method" value="mpesa" checked>
        <span>Mpesa Payment</span>
      </label>
      <label class="payment-option">
        <input type="radio" name="payment-method" value="paybill">
        <span>Paybill</span>
      </label>
    </div>
    <div id="mpesa-section">
      <p>Enter your Mpesa phone number to receive payment prompt:</p>
      <input type="tel" id="mpesa-phone" placeholder="254XXXXXXXXX" pattern="254[0-9]{9}" required />
    </div>
    <div id="paybill-section" style="display:none;">
      <p>Paybill: <strong>123456</strong></p>
      <p>Account No: <strong>0012345678</strong></p>
      <label for="payment-reference">Enter Payment Reference:</label>
      <input type="text" id="payment-reference" placeholder="Reference Number" required />
    </div>
    <button type="button" id="confirm-payment-btn">Confirm Payment</button>
  </section>

  <!-- Toast -->
  <div id="cart-toast"></div>

  <!-- Chat Button -->
  <div id="chat-btn">ðŸ’¬</div>
  
  <!-- Chat Window -->
  <div id="chat-window">
    <div id="chat-header">
      <span>TillValle Chat</span>
      <button id="chat-close">Ã—</button>
    </div>
    <div id="chat-messages">
      <div class="bot-msg">Hello! How can I help you with TillValle products today?</div>
    </div>
    <div id="chat-input-area">
      <input type="text" id="chat-input" placeholder="Type your message...">
      <button id="chat-send">Send</button>
    </div>
  </div>

  <style>
    #chat-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: #2d6a4f;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1000;
      color: white;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    #chat-window {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 350px;
      height: 400px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      z-index: 1001;
    }
    
    #chat-header {
      background: #2d6a4f;
      color: white;
      padding: 15px;
      border-radius: 10px 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    #chat-close {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
    
    #chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
    }
    
    .bot-msg, .user-msg {
      margin: 10px 0;
      padding: 8px 12px;
      border-radius: 15px;
      max-width: 80%;
    }
    
    .bot-msg {
      background: #f0f0f0;
      align-self: flex-start;
    }
    
    .user-msg {
      background: #2d6a4f;
      color: white;
      align-self: flex-end;
      margin-left: auto;
      text-align: right;
    }
    
    #chat-input-area {
      padding: 15px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
    }
    
    #chat-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      outline: none;
    }
    
    #chat-send {
      background: #2d6a4f;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
    }
  </style>

  <script>
    document.getElementById('chat-btn').onclick = function() {
      document.getElementById('chat-window').style.display = 'flex';
      document.getElementById('chat-btn').style.display = 'none';
    };
    
    document.getElementById('chat-close').onclick = function() {
      document.getElementById('chat-window').style.display = 'none';
      document.getElementById('chat-btn').style.display = 'flex';
    };
    
    function sendMessage() {
      const input = document.getElementById('chat-input');
      const messages = document.getElementById('chat-messages');
      const message = input.value.trim();
      
      if (!message) return;
      // Safely append user message
      const userMsg = document.createElement('div');
      userMsg.className = 'user-msg';
      userMsg.textContent = message;
      messages.appendChild(userMsg);
      input.value = '';
      
      setTimeout(() => {
        const botMsg = document.createElement('div');
        botMsg.className = 'bot-msg';
        botMsg.textContent = "Thanks for your message! I'm here to help with TillValle products and orders.";
        messages.appendChild(botMsg);
        messages.scrollTop = messages.scrollHeight;
      }, 1000);
      
      messages.scrollTop = messages.scrollHeight;
    }
    
    document.getElementById('chat-send').onclick = sendMessage;
    document.getElementById('chat-input').onkeypress = function(e) {
      if (e.key === 'Enter') sendMessage();
    };
  </script>

  <footer>
    <p>&copy; 2025 TilleValle. All rights reserved.</p>
  </footer>

  <script src="navbar-auth.js"></script>
  <script src="chatbot-universal.js"></script>
  <script src="script.js" defer></script>
  <script>
    // Load navbar
    fetch('navbar.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('navbar-container').innerHTML = data;
      });

    // Hide loading screen when page loads
    window.addEventListener('load', function() {
      const loadingScreen = document.getElementById('loading-screen');
      if (loadingScreen) {
        loadingScreen.classList.add('hidden');
        setTimeout(() => loadingScreen.remove(), 800);
      }
    });
    document.addEventListener('DOMContentLoaded', function() {
      // Render cart items from localStorage
      function renderCart() {
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const cartItems = document.getElementById('cart-items');
        const cartTotal = document.getElementById('cart-total');
        const cartCount = document.getElementById('cart-count');
        
        cartItems.innerHTML = '';
        let total = 0;
        
        if (cart.length === 0) {
          cartItems.innerHTML = '<li style="text-align:center;color:var(--text-secondary);padding:40px;">Your cart is empty</li>';
        } else {
          cart.forEach((item, index) => {
            total += item.price * item.quantity;
            
            const li = document.createElement('li');
            li.className = 'cart-item';
            li.innerHTML = `
              <span>${item.name} - KES ${item.price}</span>
              <div class="cart-quantity-controls">
                <button class="decrease-qty" onclick="updateQuantity(${index}, -1)">-</button>
                <input type="text" class="item-qty" value="${item.quantity}" readonly />
                <button class="increase-qty" onclick="updateQuantity(${index}, 1)">+</button>
                <button class="remove-item" onclick="removeItem(${index})" style="background:transparent;border:none;color:#ef4444;font-weight:bold;cursor:pointer;">Remove</button>
              </div>
            `;
            cartItems.appendChild(li);
          });
        }
        
        cartTotal.textContent = `Total: KSh ${total}`;
        const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
        if (cartCount) cartCount.textContent = totalQuantity;
      }
      
      // Update quantity function
      window.updateQuantity = function(index, change) {
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        cart[index].quantity += change;
        if (cart[index].quantity <= 0) {
          cart.splice(index, 1);
        }
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
      };
      
      // Remove item function
      window.removeItem = function(index) {
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        cart.splice(index, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
      };
      
      // Initial render
      renderCart();
      
      // Checkout button event listener
      document.getElementById('checkout-btn').addEventListener('click', () => {
        window.location.href = 'location.html';
      });
      // Chatbot functions
      const floatingChatbotBtn = document.getElementById('floating-chatbot-btn');
      const chatbotSidebar = document.getElementById('chatbot-sidebar');
      const chatbotClose = document.getElementById('chatbot-close');
      const chatbotSend = document.getElementById('chatbot-send');
      const chatbotInput = document.getElementById('chatbot-input');
      
      if (floatingChatbotBtn) {
        floatingChatbotBtn.addEventListener('click', () => {
          if (chatbotSidebar) chatbotSidebar.classList.add('open');
          floatingChatbotBtn.style.display = 'none';
        });
      }
      if (chatbotClose) {
        chatbotClose.addEventListener('click', () => {
          if (chatbotSidebar) chatbotSidebar.classList.remove('open');
          if (floatingChatbotBtn) floatingChatbotBtn.style.display = 'flex';
        });
      }
      if (chatbotSend) {
        chatbotSend.addEventListener('click', sendMessage);
      }
      if (chatbotInput) {
        chatbotInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') sendMessage();
        });
      }
      
      async function sendMessage() {
        const message = chatbotInput.value.trim();
        if (!message) return;
        
  const messagesDiv = document.getElementById('chatbot-messages');
  // Safely append user message
  const userMessageDiv = document.createElement('div');
  userMessageDiv.className = 'chatbot-message user';
  userMessageDiv.textContent = message;
  messagesDiv.appendChild(userMessageDiv);
        chatbotInput.value = '';
  const thinkingDiv = document.createElement('div');
  thinkingDiv.className = 'chatbot-message bot';
  thinkingDiv.textContent = 'Thinking...';
  messagesDiv.appendChild(thinkingDiv);
  const loadingMessage = messagesDiv.lastElementChild;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        try {
          const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
          const chatbotUrl = isLocal ? 'http://localhost:3001/chatbot' : '/.netlify/functions/chatbot';
          const response = await fetch(chatbotUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
          });
          const data = await response.json();
          if (loadingMessage) loadingMessage.remove();
          const botReply = document.createElement('div');
          botReply.className = 'chatbot-message bot';
          botReply.textContent = data.message;
          messagesDiv.appendChild(botReply);
        } catch (error) {
          if (loadingMessage) loadingMessage.remove();
          const currentLang = localStorage.getItem('selectedLanguage') || 'en';
          const lowerMessage = message.toLowerCase();
          const offlineResponses = {
            en: {
              human: "I'll connect you with our live chat agent Angela Wanjiru at angelawanjiru@gmail.com.",
              default: "Hello! I'm TillieBot from TillValle! ðŸŒ± I can help you with product information, stock levels, and delivery details. What would you like to know?"
            },
            sw: {
              human: "Nitakuunganisha na wakala wetu Angela Wanjiru kwa angelawanjiru@gmail.com.",
              default: "Hujambo! Mimi ni TillieBot kutoka TillValle! ðŸŒ± Ninaweza kukusaidia na habari za bidhaa na uongozaji. Unahitaji nini?"
            },
            fr: {
              human: "Je vais vous connecter avec notre agent Angela Wanjiru Ã  angelawanjiru@gmail.com.",
              default: "Bonjour! Je suis TillieBot de TillValle! ðŸŒ± Je peux vous aider avec les informations produits et la livraison. Que voulez-vous savoir?"
            }
          };
          const responses = offlineResponses[currentLang] || offlineResponses.en;
          const respDiv = document.createElement('div');
          respDiv.className = 'chatbot-message bot';
          respDiv.textContent = (lowerMessage.includes('human') || lowerMessage.includes('agent') || lowerMessage.includes('live')) ? responses.human : responses.default;
          messagesDiv.appendChild(respDiv);
        }
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    });
  </script>
</body>
</html>
